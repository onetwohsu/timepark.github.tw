<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™‚å…‰æ¨‚åœ’ - æ¥µé€Ÿæµæš¢ä¿®æ­£ç‰ˆ</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    
    <script>
      let collectedShards = 0;
      let bgmInstance = null;
      let moveKeyStatus = { up: false, down: false, left: false, right: false };
      let isRunning = false;

      // 1. é«˜æ•ˆèƒ½æ…¶å…¸ç³»çµ±
      AFRAME.registerComponent('celebration-system', {
        init: function () { 
          this.active = false;
          this.particlePool = 0;
        },
        tick: function () {
          if (!this.active) return;
          if (Math.random() > 0.96) this.createMegaFirework(); 
          if (this.particlePool < 40) {
            this.createSuperConfetti();
          }
        },
        createMegaFirework: function () {
          const colors = ['#FF00FF', '#00FFFF', '#FFD700'];
          for(let i=0; i<10; i++) { 
            const fw = document.createElement('a-box');
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            fw.setAttribute('position', {x: 0, y: 20, z: 0}); 
            fw.setAttribute('scale', '1.5 1.5 1.5'); 
            fw.setAttribute('color', randomColor);
            fw.setAttribute('material', 'shader: flat; emissive: ' + randomColor);
            fw.setAttribute('animation', { property: 'position', to: `${(Math.random()-0.5)*40} ${60+Math.random()*20} ${(Math.random()-0.5)*40}`, dur: 1000, easing: 'easeOutExpo' });
            this.el.appendChild(fw);
            setTimeout(() => { if(fw.parentNode) fw.parentNode.removeChild(fw); }, 1200);
          }
        },
        createSuperConfetti: function () {
          this.particlePool++;
          const confetti = document.createElement('a-box');
          confetti.setAttribute('position', `${(Math.random()-0.5)*100} 60 ${(Math.random()-0.5)*100}`);
          confetti.setAttribute('scale', Math.random() > 0.5 ? '0.5 3 0.5' : '1 1 1');
          confetti.setAttribute('color', ['#FF0000', '#00FF00', '#0000FF', '#FFFF00'][Math.floor(Math.random()*4)]);
          confetti.setAttribute('material', 'shader: flat');
          confetti.setAttribute('animation', { property: 'position', to: `${(Math.random()-0.5)*100} -5 ${(Math.random()-0.5)*100}`, dur: 2000, easing: 'linear' });
          this.el.appendChild(confetti);
          setTimeout(() => { 
            if(confetti.parentNode) confetti.parentNode.removeChild(confetti); 
            this.particlePool--;
          }, 2000);
        }
      });

      // 2. é †æ»‘ç§»å‹•çµ„ä»¶
      AFRAME.registerComponent('smooth-move', {
        tick: function (time, timeDelta) {
          const rig = this.el;
          const camera = document.querySelector('#main-camera');
          if (!camera) return;
          const rotation = camera.getAttribute('rotation');
          const angle = (rotation.y * Math.PI) / 180;
          const speed = (isRunning ? 1.5 : 0.7) * (timeDelta / 16); 
          let dx = 0, dz = 0;
          if (moveKeyStatus.up) { dx -= Math.sin(angle) * speed; dz -= Math.cos(angle) * speed; }
          if (moveKeyStatus.down) { dx += Math.sin(angle) * speed; dz += Math.cos(angle) * speed; }
          if (moveKeyStatus.left) { dx -= Math.cos(angle) * speed; dz += Math.sin(angle) * speed; }
          if (moveKeyStatus.right) { dx += Math.cos(angle) * speed; dz -= Math.sin(angle) * speed; }
          if (dx !== 0 || dz !== 0) {
            const pos = rig.getAttribute('position');
            rig.setAttribute('position', { x: pos.x + dx, y: pos.y, z: pos.z + dz });
          }
        }
      });

      AFRAME.registerComponent('ground-lock-tps', {
        tick: function () {
          const camera = document.querySelector('#main-camera');
          if (!camera) return;
          const camRot = camera.getAttribute('rotation');
          this.el.setAttribute('rotation', { x: 0, y: camRot.y + 90, z: 0 });
          const angle = (camRot.y * Math.PI) / 180;
          this.el.setAttribute('position', { x: -Math.sin(angle) * 3, y: 0, z: -Math.cos(angle) * 3 });
        }
      });

      // 3. é‚è¼¯æ§åˆ¶
      function setMove(dir, status) { moveKeyStatus[dir] = status; }
      function toggleRun() {
        isRunning = !isRunning;
        document.getElementById('run-btn').style.background = isRunning ? "#ff4d4d" : "#7ed957";
      }
      function enterPark() {
        document.getElementById('welcome-overlay').style.display = 'none';
        bgmInstance = document.getElementById('happy-bgm');
        bgmInstance.play().catch(() => {});
      }
      function collectShard() {
        const popup = document.getElementById('info-screen');
        const targetId = popup.getAttribute('data-target-id');
        const targetEl = document.getElementById(targetId);
        if (targetEl && !targetEl.classList.contains('collected')) {
          targetEl.classList.add('collected');
          targetEl.setAttribute('material', 'emissive: #FFD700; emissiveIntensity: 2');
          collectedShards++;
          document.getElementById('shard-count').innerText = collectedShards;
          if (collectedShards >= 4) setTimeout(() => { document.getElementById('victory-screen').style.display = 'flex'; }, 500);
        }
        popup.style.display = 'none';
      }
      function showPopup(id, title, img) {
        const s = document.getElementById('info-screen');
        document.getElementById('display-img').src = img;
        document.getElementById('info-title').innerText = title;
        s.setAttribute('data-target-id', id);
        s.style.display = 'flex';
      }
    </script>

    <style>
      * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none; }
      body { margin: 0; overflow: hidden; background: #fff; font-family: sans-serif; }
      #shard-counter-ui { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; z-index: 1000; font-weight: bold; }
      #welcome-overlay, #info-screen, #victory-screen, #achievement-overlay, #coupon-overlay { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10000; text-align:center; background:#fff; }
      #info-screen, #victory-screen, #achievement-overlay, #coupon-overlay { display:none; background:rgba(255,255,255,0.98); z-index:20000; }
      img { max-width: 80%; max-height: 40%; border-radius: 10px; border: 4px solid #7ed957; margin-bottom: 10px; }
      .btn { padding: 12px 25px; font-size: 18px; border: none; border-radius: 25px; background: #7ed957; color: white; font-weight: bold; margin: 5px; }
      .move-controls { position: fixed; bottom: 20px; right: 20px; display: grid; grid-template-areas: ". up ." "left run right" ". down ."; gap: 10px; z-index: 999; }
      .pixel-btn { width: 55px; height: 55px; background: rgba(126,217,87,0.8); border: 2px solid #fff; border-radius: 12px; color: white; font-size: 20px; font-weight: bold; }
    </style>
  </head>
  <body>

    <audio id="happy-bgm" src="audio/happy_bgm.mp3" loop></audio>

    <div id="shard-counter-ui">ğŸ’ <span id="shard-count">0</span> / 4</div>

    <div id="welcome-overlay">
      <h1 style="color: #7ed957">æ™‚å…‰æ¨‚åœ’</h1>
      <button class="btn" onclick="enterPark()">é–‹å§‹æ¢ç´¢</button>
    </div>

    <div id="info-screen">
      <h2 id="info-title">è¨­æ–½</h2>
      <img id="display-img" src="">
      <button class="btn" onclick="collectShard()">é ˜å–ç¢ç‰‡</button>
      <button class="btn" style="background:#888" onclick="document.getElementById('info-screen').style.display='none'">é—œé–‰</button>
    </div>

    <div id="victory-screen">
      <h1>âœ¨ æ…¶å…¸æ­å¹• âœ¨</h1>
      <img src="picture/whole.jpg">
      <button class="btn" onclick="document.getElementById('victory-screen').style.display='none'; document.querySelector('a-scene').components['celebration-system'].active=true; setTimeout(()=>document.getElementById('achievement-overlay').style.display='flex', 10000)">å•Ÿå‹•æ´¾å°</button>
    </div>

    <div id="achievement-overlay">
      <div style="background:#FFD700; padding:30px; border-radius:20px; border:5px solid #fff">
        <h2>ğŸ† æ¢ç´¢å®¶ç¨±è™Ÿ</h2>
        <button class="btn" style="background:#000" onclick="document.getElementById('achievement-overlay').style.display='none'; document.getElementById('coupon-overlay').style.display='flex'">é ˜å–å„ªæƒ åˆ¸</button>
      </div>
    </div>

    <div id="coupon-overlay">
      <div style="background:#ff4d4d; padding:30px; border-radius:20px; border:5px solid #fff; color:#fff">
        <h2>ğŸ« æ­å–œç²å¾—å„ªæƒ åˆ¸</h2>
        <button class="btn" style="background:#fff; color:#ff4d4d" onclick="location.reload()">é‡æ–°éŠç©</button>
      </div>
    </div>

    <div class="move-controls">
      <button class="pixel-btn" style="grid-area: up;" ontouchstart="setMove('up', true)" ontouchend="setMove('up', false)">â†‘</button>
      <button class="pixel-btn" style="grid-area: left;" ontouchstart="setMove('left', true)" ontouchend="setMove('left', false)">â†</button>
      <button id="run-btn" class="pixel-btn" style="grid-area: run;" onclick="toggleRun()">âš¡</button>
      <button class="pixel-btn" style="grid-area: right;" ontouchstart="setMove('right', true)" ontouchend="setMove('right', false)">â†’</button>
      <button class="pixel-btn" style="grid-area: down;" ontouchstart="setMove('down', true)" ontouchend="setMove('down', false)">â†“</button>
    </div>

    <a-scene celebration-system renderer="antialias: false; precision: low; powerPreference: high-performance" shadow="enabled: false">
      <a-assets>
        <a-asset-item id="ferris-model" src="models/ferris_wheel.glb"></a-asset-item>
        <a-asset-item id="abo-model" src="models/abo.glb"></a-asset-item>
        <a-asset-item id="boat-model" src="models/boat.glb"></a-asset-item>
        <a-asset-item id="car-model" src="models/car.glb"></a-asset-item>
        <a-asset-item id="horse-model" src="models/horse.glb"></a-asset-item>
        <a-asset-item id="castle-model" src="models/castle.glb"></a-asset-item>
      </a-assets>

      <a-entity environment="preset: forest; ground: flat; dressingAmount: 4; dressingScale: 0.5; lighting: none;"></a-entity>
      <a-light type="ambient" intensity="1.5"></a-light>
      <a-light type="directional" position="1 2 1"
